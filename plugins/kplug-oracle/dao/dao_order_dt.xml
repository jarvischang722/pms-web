<?xml version="1.0" encoding="UTF-8"?>
<root>
    <!-- ['PMS0110040'] 訂房卡明細-->
    <dao name="QRY_ORDER_DT">
        <statement><![CDATA[
            select order_dt.ikey, order_dt.ikey_seq_nos "order_dt.ikey_seq_nos", order_dt.room_nos "order_dt.room_nos",
            pg_hfd_get_nam2.sf_hfd_get_guest_list( order_mn.athena_id,order_mn.hotel_cod,order_dt.ikey, order_dt.ikey_seq_nos,'#1####' ) full_nam,
            order_dt.order_sta "order_dt.order_sta", order_dt.ci_dat "order_dt.ci_dat", order_dt.co_dat "order_dt.co_dat",
            order_dt.days "order_dt.days", order_dt.rate_cod "order_dt.rate_cod",
            order_dt.use_cod "order_dt.use_cod", order_dt.use_cod "order_dt.use_sna", order_dt.room_cod "order_dt.room_cod",
            order_dt.room_cod "order_dt.room_sna", order_dt.order_qnt "order_dt.order_qnt", order_dt.assign_qnt "order_dt.assign_qnt",
            order_dt.ci_qnt "order_dt.ci_qnt",
            order_dt.rent_amt,
            order_dt.serv_amt,
            order_mn.group_nos,
            order_mn.acust_nam,
            order_mn.atten_nam,
            order_mn.sales_cod,
            order_dt.source_typ "order_dt.source_typ",
            order_dt.guest_typ "order_dt.guest_typ",
            order_mn.rvreserve_nos
            from order_dt, order_mn, guest_rf g
            where order_dt.athena_id = g.athena_id(+)
            and order_dt.guest_typ = g.guest_typ(+)
            and order_dt.athena_id = order_mn.athena_id
            and order_dt.hotel_cod = order_mn.hotel_cod
            and order_dt.ikey = order_mn.ikey
            and order_dt.athena_id = :athena_id
            and order_dt.hotel_cod = :hotel_cod
            and order_dt.ikey = order_mn.ikey
            and order_dt.order_sta <> 'X'
            order by ikey,ikey_seq_nos
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
    </dao>

    <!--
    [PMS0110041] 取得qry_order_dt
    -->
    <dao name="QRY_CARD_ORDER_DT">
        <statement><![CDATA[
            select * from order_dt where athena_id = :athena_id and hotel_cod = :hotel_cod and ikey = :ikey and order_sta <> 'X'
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
        <orderby>ORDER BY ikey_seq_nos</orderby>
    </dao>

    <dao name="QRY_ORDER_DT_FOR_DETAIL_GROUP">
        <statement><![CDATA[
            select d.ikey_seq_nos, d.order_sta, d.ci_dat, d.co_dat, d.rate_cod, m.ratecod_nam, d.use_cod, d.rent_amt, d.serv_amt,
            d.order_qnt, d.rent_tot, d.room_cod, d.adult_qnt, d.child_qnt, d.baby_qnt
            from order_dt d
            join ratecod_mn m on d.athena_id = m.athena_id and d.hotel_cod = m.hotel_cod
            and d.rate_cod = m.rate_cod
            where d.order_sta <> 'X'
            and d.athena_id = :athena_id
            and d.hotel_cod = :hotel_cod
            and d.ikey = :ikey
            order by ikey_seq_nos
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
    </dao>

    <dao name="QRY_DETAIL_ORDER_DT">
        <statement><![CDATA[
            select ikey_seq_nos, ci_dat, days, co_dat,rate_cod, use_cod, room_cod,
            rent_amt, serv_amt, order_dt.commis_rat, order_dt.adult_qnt, order_dt.child_qnt,
            order_dt.baby_qnt, order_dt.source_typ, order_dt.guest_typ, order_dt.assign_sta, order_dt.room_nos,
            pg_hfd_get_nam2.sf_hfd_get_guest_list(:athena_id, :hotel_cod, ikey, ikey_seq_nos, '#1####') guest_list
            from order_dt
            where athena_id = :athena_id
            and hotel_cod = :hotel_cod
            and ikey = :ikey
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
        <parameter type="instring" kind="3">ikey_seq_nos</parameter>
        <statement test="_v(param.ikey_seq_nos)"><![CDATA[and ikey_seq_nos in(:ikey_seq_nos)]]></statement>
        <orderby>order by ikey_seq_nos</orderby>
    </dao>

    <dao name="SEL_ORDER_DT_MAX_IKEY_SEQ_NOS">
        <statement><![CDATA[
            select max(ikey_seq_nos) ikey_seq_nos
            from order_dt
            where athena_id = :athena_id
            and hotel_cod = :hotel_cod
            and ikey = :ikey
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
    </dao>


    <!-- ['PMS0820010'] 未來入住之訂房卡明細-->
    <dao name="CHK_ORDER_DT_ISEXIST">
        <statement><![CDATA[
              SELECT COUNT(*) AS order_dt_count FROM
              ORDER_DT WHERE
              ATHENA_ID = trim(:athena_id) AND trim(HOTEL_COD) = trim(:hotel_cod) AND  ORDER_STA = 'N' AND CI_DAT >= to_date(trim(:belong_dat), 'YYYY/MM/DD') AND INSTR( trim(CHARACTER_RMK), ''''|| trim(:character_cod) || '''' ) > 0 AND ROWNUM <= 1
        ]]>
        </statement>
        <parameter type="string" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">belong_dat</parameter>
        <parameter type="string" kind="3">character_cod</parameter>
    </dao>

    <!-- [prg_id: PMS0810090 ] -->
    <dao name="GET_ORDER_DT.GUEST_TYP_COUNT">
        <statement><![CDATA[
       select count(*)  as guest_count
       from order_dt
        where athena_id = ?  and trim(hotel_cod) = trim(?)
        and trim(guest_typ) = trim(?) and rownum = 1
        ]]>
        </statement>
        <parameter type="number" kind="1">athena_id</parameter>
        <parameter type="string" kind="1">hotel_cod</parameter>
        <parameter type="string" kind="1">guest_typ</parameter>
    </dao>



    <!-- [prg_id: PMS0110042 ]  取得住客清單-->
    <dao name="QRY_HOUSES_INFO_DETAIL">
        <statement><![CDATA[
        select ikey_seq_nos,room_nos,
        pg_hfd_get_nam2.sf_hfd_get_guest_list(athena_id, hotel_cod, ikey, ikey_seq_nos, '#1####') guest_list from order_dt
        where order_sta <> 'X'
        and athena_id = :athena_id
        and hotel_cod = :hotel_cod
        and ikey = :ikey
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
    </dao>
</root>