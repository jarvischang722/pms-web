<?xml version="1.0" encoding="UTF-8"?>
<root>
    <!-- ['PMS0810090']-->
    <dao name="GET_GUEST_MN.GUEST_TYP_COUNT">
        <statement><![CDATA[
            select count(*) as guest_count
             from guest_mn
             where athena_id = ? and trim(guest_typ) = ? and rownum = 1
        ]]>
        </statement>
        <parameter type="number" kind="1">athena_id</parameter>
        <parameter type="string" kind="1">guest_typ</parameter>
    </dao>

    <!-- ['PMS0820040'] 檢查住客歷史有無用到-->
    <dao name="GET_GUEST_MN.AIRLINE_COD_COUNT">
        <statement><![CDATA[
            select count(*) as guest_count
             from guest_mn
             where athena_id = ? and trim(airline_cod) = :airline_cod and rownum = 1
        ]]>
        </statement>
        <parameter type="number" kind="1">athena_id</parameter>
        <parameter type="string" kind="3">airline_cod</parameter>
    </dao>

    <!-- ['PMS0820040'] 檢查住客歷史有無用到-->
    <dao name="GET_GUEST_MN.AIRLINE_COD_COUNT">
        <statement><![CDATA[
            select count(*) as guest_count
             from guest_mn
             where athena_id = ? and trim(airline_cod) = :airline_cod and rownum = 1
        ]]>
        </statement>
        <parameter type="number" kind="1">athena_id</parameter>
        <parameter type="string" kind="3">airline_cod</parameter>
    </dao>

    <!-- [PMS0610020 商務公司資料編輯] 合約內容
        合約指定的房價代號未有相關訂房卡指定則可刪除合約 -->
    <dao name="CHK_RATE_COD_IS_EXIST_IN_GUEST_MN">
        <statement><![CDATA[
            SELECT  COUNT(*) as order_rate_Count
            FROM  GUEST_MN
            WHERE  ATHENA_ID = :athena_id
            AND  ACUST_COD = :cust_cod
            AND  trim(HOTEL_COD) = trim(:hotel_cod)
            AND  trim(RATE_COD) = trim(:rate_cod)
            AND  ROWNUM <= 1
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">cust_cod</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">rate_cod</parameter>
    </dao>

    <!-- PMS0210011 住客歷史資料編輯 取得『預約來館資料』-->
    <dao name="QRY_GUEST_MN">
        <statement><![CDATA[
            SELECT  DISTINCT ORDER_DT.ORDER_STA "ORDER_DT.ORDER_STA", ORDER_DT.CI_DAT "ORDER_DT.CI_DAT", ORDER_DT.CO_DAT "ORDER_DT.CO_DAT", ORDER_MN.ACUST_NAM "ORDER_MN.ACUST_NAM",
            ORDER_MN.CUST_NAM "ORDER_MN.CUST_NAM", ORDER_MN.ATTEN_NAM "ORDER_MN.ATTEN_NAM", ORDER_DT.RATE_COD "ORDER_DT.RATE_COD",
            ORDER_DT.USE_COD "ORDER_DT.USE_COD", ORDER_DT.ORDER_QNT "ORDER_DT.ORDER_QNT", ORDER_DT.RENT_AMT "ORDER_DT.RENT_AMT", ( ORDER_DT.ADULT_QNT + ORDER_DT.CHILD_QNT + ORDER_DT.BABY_QNT ) "order_dt.guest_qnt",
            ORDER_DT.IKEY "ORDER_DT.IKEY", ORDER_DT.IKEY_SEQ_NOS "ORDER_DT.IKEY_SEQ_NOS"
            FROM  ORDER_DT, ORDER_MN, GUEST_MN
            WHERE  ORDER_MN.ATHENA_ID = ORDER_DT.ATHENA_ID
            AND  ORDER_MN.IKEY = ORDER_DT.IKEY
            AND  ORDER_DT.ATHENA_ID = GUEST_MN.ATHENA_ID
            AND  ORDER_DT.IKEY = GUEST_MN.IKEY
            AND  ORDER_DT.IKEY_SEQ_NOS = GUEST_MN.IKEY_SEQ_NOS
            AND  ORDER_DT.CI_DAT >= to_date(:rent_cal_dat, 'YYYY/MM/DD')
            AND  ORDER_DT.ORDER_STA <> 'D'
            AND  GUEST_MN.ATHENA_ID = :athena_id
            AND  GUEST_MN.GCUST_COD = :gcust_cod
            AND  ORDER_MN.HOTEL_COD = trim(:hotel_cod)
            ORDER BY  ORDER_DT.CI_DAT, ORDER_DT.IKEY, ORDER_DT.IKEY_SEQ_NOS
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">gcust_cod</parameter>
        <parameter type="string" kind="3">rent_cal_dat</parameter>
    </dao>

    <!-- PMS0210011 住客歷史資料編輯 『檢查是否為在館住客及未來訂房卡住客資料』-->
    <dao name="CHK_GUEST_MN_IS_EXIST">
        <statement><![CDATA[
            SELECT  GUEST_MN.ALT_NAM, GHIST_MN.SHOW_COD, GUEST_MN.HOTEL_COD, HOTEL_RF.HOTEL_NAM
            FROM  GUEST_MN, GHIST_MN, ORDER_DT, HOTEL_RF
            WHERE  GUEST_MN.ATHENA_ID = GHIST_MN.ATHENA_ID
            AND  GUEST_MN.GCUST_COD = GHIST_MN.GCUST_COD
            AND  GUEST_MN.ATHENA_ID = ORDER_DT.ATHENA_ID
            AND  GUEST_MN.IKEY = ORDER_DT.IKEY
            AND  GUEST_MN.IKEY_SEQ_NOS = ORDER_DT.IKEY_SEQ_NOS
            AND  GUEST_MN.ATHENA_ID = HOTEL_RF.ATHENA_ID
            AND  GUEST_MN.HOTEL_COD = HOTEL_RF.HOTEL_COD
            AND  ( GUEST_MN.GUEST_STA IN ( 'K', 'O' ) OR
                   ORDER_DT.CI_DAT >= TO_DATE( PG_AIS2.SF_GET_HOTEL_SVAL( ORDER_DT.HOTEL_COD, 'HFD', 'rent_cal_dat', :athena_id ), 'YYYY/MM/DD' ) )
            AND  GUEST_MN.ATHENA_ID = :athena_id
            AND  GUEST_MN.GCUST_COD = :gcust_cod
            AND  GUEST_MN.SYSTEM_TYP = 'HFD'
            AND  ROWNUM <= 1

        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">gcust_cod</parameter>
    </dao>

    <!-- ['PMS0110041'] ???????-->
    <dao name="SEL_ACUST_NAM">
        <statement><![CDATA[
           select idx.show_cod,idx.cust_cod,idx.alt_nam,idx.uni_cod,idx.office_tel,mn.sales_cod,
           (trim(idx.cust_cod ||':'|| mn.cust_nam)) guest_display
           from cust_idx idx join cust_mn mn on idx.athena_id = mn.athena_id and idx.cust_cod  = mn.cust_cod
           where from_table = 'CUST_MN' and cust_sta <> 'D'
        ]]>
        </statement>
        <orderby>order by alt_nam</orderby>
    </dao>

    <dao name="QRY_DETAIL_GUEST_MN">
        <statement><![CDATA[
           select A.GCUST_COD, a.ikey_seq_nos,(a.gcust_cod||':'||a.alt_nam) as alt_nam,a.assign_sta,a.room_nos,b.contry_cod,a.ikey_seq_nos,
            (select pref_room
            from Ghist_visit_dt
            where athena_id = :athena_id
            and hotel_cod = :hotel_cod
            and gcust_cod = a.gcust_cod) pref_room,
            B.CAR_NOS, a.athena_id, a.hotel_cod, a.ci_ser
           from guest_mn a, ghist_mn b
           where a.athena_id = b.athena_id
           and a.gcust_cod = b.gcust_cod
           and a.ikey = :ikey
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
        <orderby>order by decode(a.ikey_seq_nos,0,9999)</orderby>
    </dao>

    <!-- PMS0110042 查詢尚未指定房組的住客-->
    <dao name="QRY_HOUSES_INFO_DETAIL_GUEST">
        <statement><![CDATA[
            select a.athena_id, a.hotel_cod, a.ci_ser, a.ikey_seq_nos, a.alt_nam from guest_mn a
            where a.guest_sta <> 'X'
            and a.athena_id = :athena_id
            and a.hotel_cod = :hotel_cod
            and a.ikey = :ikey
            and master_sta = 'G'
            and a.ikey_seq_nos = 0
        ]]>
        </statement>
        <parameter type="number" kind="3">athena_id</parameter>
        <parameter type="string" kind="3">hotel_cod</parameter>
        <parameter type="string" kind="3">ikey</parameter>
        <orderby>order by ci_ser</orderby>
    </dao>


</root>