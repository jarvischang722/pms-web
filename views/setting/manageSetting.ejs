<!DOCTYPE html>
<html lang="en">
<%- include ../common/head %>
<%- include ../common/importFiles %>


<body class="no-skin" id="app">
<style>

    .disabled {
        pointer-events: none;
        opacity: 0.4;
    }
</style>
<!-- #section:basics/navbar.layout -->
<%- include ../common/navbar.ejs %>
<!-- include header.html -->
<script type="text/javascript">

    $(function () {
        //選第一個對照檔
        $("#settingUl li").first().find("a").click();

    })

</script>
<!-- /section:basics/navbar.layout -->
<div class="main-container ace-save-state" id="main-container" style="margin-top: 35px;">

    <div id="sidebar" class="sidebar responsive ace-save-state sidebar-fixed">


        <%- include('../common/moduleMenu',{}) %>

        <div class="companyInfo">
            <img src="/images/athena_log.png"/>
        </div>
        <!-- /section:basics/sidebar.layout.minimize -->
    </div>

    <!-- /section:basics/sidebar -->

    <div class="main-content">
        <div class="main-content-inner">

            <%- include('../common/subsysMenu',{}) %>

            <div class="page-content">
                <div class="controlReservation">
                    <div class="page-header">
                    </div><!-- /.page-header -->
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <!-- #section:elements.tab.position -->
                                                    <div class="tabbable tabs-left">
                                                        <ul class="nav nav-tabs" id="settingUl">
                                                            <li class="active">
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810010')"
                                                                   href="#">
                                                                    <%= __("room_group") %>
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810040')"
                                                                   href="#">
                                                                    <%= __("state_conf") %>
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810020')"
                                                                   href="#">
                                                                    <%= __("Room Type") %>
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810130')"
                                                                   href="#">
                                                                    訂房分類
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810080')"
                                                                   href="#">
                                                                    住客類別群組
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810100')"
                                                                   href="#">
                                                                    訂房卡來源群組設定
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"
                                                                   @click="loadSetUpPage('PMS0810090')"
                                                                   href="#">
                                                                    住客類別設定
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"來源
                                                                   @click="loadSetUpPage('PMS0810110')"
                                                                   href="#">
                                                                    訂房卡設定
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"來源
                                                                   @click="loadSetUpPage('PMS0810140')"
                                                                   href="#">
                                                                    FOC設定
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-toggle="tab"來源
                                                                   @click="loadSetUpPage('PMS0810200')"
                                                                   href="#">
                                                                    交辦事項設定
                                                                </a>
                                                            </li>
                                                        </ul>

                                                        <div class="tab-content">
                                                            <!-- 對照檔內容 -->
                                                            <div id="prgContentDiv" v-show="!isTableLocked"
                                                                 style="overflow-x: hidden;display: none;"
                                                                 class="tab-pane in active">
                                                            </div>

                                                            <!-- table lock 訊息 -->
                                                            <div align="center" v-show="isTableLocked"
                                                                 style="display: none;">
                                                                <p>
                                                                    <image width="64" src="/images/lock.png"/>
                                                                </p>
                                                                <p>
                                                                    <span style="font-size: 2em !important;"> {{tableLockMsg}} </span>
                                                                </p>

                                                            </div>

                                                        </div>
                                                    </div>

                                                    <!-- /section:elements.tab.position -->
                                                </div><!-- /.col -->


                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div><!-- /.roomNumPlanPage -->
            </div>
        </div>
    </div><!-- /.main-content -->
    <%- include ../common/footer %>

    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
        <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
    </a>
</div><!-- /.main-container -->

<!-- basic scripts -->


</body>

<script>
    var socket = io.connect('/setup');
    var userInfo = <%-JSON.stringify(session.user)%>;
    var vmMain = new Vue({
        el: '#main-container',
        data: {
            isTableLockProcessing: true,  //打API 上鎖程序是否正在執行
            usingPrgID: "",  //使用中的prg_id
            isTableLocked: false,// 是否被上鎖中
            tableLockMsg: "",// 上鎖訊息
            userInfo:<%- JSON.stringify(session.user || {}) %>
        },
        ready: function () {
            //偵測離開頁面
            $(window).on('beforeunload', function () {
                if (!_.isEmpty(vmMain.usingPrgID)) {
                    return vmMain.doTableUnLock();
                }

            });

            this.doFirstPrg();
        },
        watch: {},
        methods: {
            doFirstPrg: function () {
                this.loadSetUpPage('PMS0810010');
            },
            //讀取網頁程式頁面
            loadSetUpPage: function (this_prg_id) {

                waitingDialog.show("Loading...");

                $("#prgContentDiv").empty();
                this.isTableLocked = false;

                //判斷是否要Unlock
                if (!_.isEmpty(this.usingPrgID) && !_.isEqual(this_prg_id, this.usingPrgID)) {
                    this.isTableLockProcessing = true;
                    this.doTableUnLock(function (errorMsg, success) {
                        this.isTableLockProcessing = false;
                        console.log("解開lock:" + vmMain.usingPrgID);
                        vmMain.isTableLocked = false;
                    })
                }



                // Start
                // 把dialog 在div產生的html 刪除, 不然會導致另一個對照檔開錯dialog
                $(".panel.window").remove();
                $(".window-shadow").remove();
                $(".window-mask").remove();
                //End

                if (!_.isEmpty(this.usingPrgID) && _.isEqual(this_prg_id, this.usingPrgID)) {
                    $("#prgContentDiv").load('/mainSetUp/' + this_prg_id + "?_r=" + (new Date()).getTime());

                } else {
                    this.isTableLockProcessing = true;
                    this.doTableLock(this_prg_id);
                }

            },
            //資料表上鎖
            doTableLock: function (prg_id) {
                socket.emit('handleTableLock', {
                    'prg_id':prg_id,
                    'user': userInfo
                })
            },
            //資料表解鎖
            doTableUnLock: function (callback) {
                socket.emit('handleTableUnlock', {
                    'prg_id':vmMain.usingPrgID,
                    'user': userInfo
                })
                callback(null,true);
            }


        }
    })

    //lock 結果
    socket.on('checkTableLock', function (result) {
        console.log(result);
        vmMain.isTableLockProcessing = false;
        vmMain.isTableLocked = !result.success;
        vmMain.tableLockMsg = result.errorMsg;
        vmMain.isTableLockProcessing = false;
        if (!vmMain.isTableLocked) {
            vmMain.usingPrgID = result.prg_id.trim();  //確實是此使用者鎖上的才能註冊這個prg_id
            $("#prgContentDiv").empty().load('/mainSetUp/' + result.prg_id);
        }else{
            vmMain.usingPrgID = "";
            waitingDialog.hide();
        }
    })
</script>
</html>
